"use strict";var sugar=angular.module("sugar",["ui.router","ui.bootstrap","duParallax","textAngular","ngSanitize","restangular","ngTable","angularFileUpload"]);sugar.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){c.defaults.useXDomain=!0,a.state("home",{url:"/",views:{content:{templateUrl:"components/sections/index.html",controller:"SectionsController"},header:{templateUrl:"components/header/index.html"},footer:{templateUrl:"components/footer/index.html"}},authenticate:!1}).state("admin",{"abstract":!0,url:"/admin",views:{header:{templateUrl:"components/header/admin.html"},footer:{templateUrl:"components/footer/index.html"}},authenticate:!0}).state("admin-images",{url:"/admin/images",views:{header:{templateUrl:"components/header/admin.html"},footer:{templateUrl:"components/footer/index.html"},content:{templateUrl:"components/admin/images.html",controller:"AdminImagesController"}},authenticate:!0}).state("admin-sections",{url:"/admin/sections",views:{header:{templateUrl:"components/header/admin.html"},footer:{templateUrl:"components/footer/index.html"},content:{templateUrl:"components/admin/sections.html",controller:"AdminSectionsController"}},authenticate:!0}).state("admin-services",{url:"/admin/services",views:{header:{templateUrl:"components/header/admin.html"},footer:{templateUrl:"components/footer/index.html"},content:{templateUrl:"components/admin/services.html",controller:"AdminServicesController"}},authenticate:!0}).state("admin-specials",{url:"/admin/specials",views:{header:{templateUrl:"components/header/admin.html"},footer:{templateUrl:"components/footer/index.html"},content:{templateUrl:"components/admin/specials.html",controller:"AdminSpecialsController"}},authenticate:!0}).state("admin-contact",{url:"/admin/contact",views:{header:{templateUrl:"components/header/admin.html"},footer:{templateUrl:"components/footer/index.html"},content:{templateUrl:"components/admin/contact.html",controller:"AdminContactController"}},authenticate:!0}).state("login",{url:"/login",views:{content:{templateUrl:"components/login/index.html",controller:"LoginController"},header:{templateUrl:"components/header/index.html"},footer:{templateUrl:"components/footer/index.html"}},authenticate:!1}),b.otherwise("/")}]),sugar.config(["RestangularProvider",function(a){var b="http://api.sugarsandiego.com";a.setBaseUrl(b).setDefaultHttpFields({withCredentials:!0}).setDefaultHeaders({"Content-Type":"application/json"})}]),sugar.run(["$rootScope","$state","AuthFactory","Restangular",function(a,b,c,d){a.$on("$stateChangeStart",function(a,e){var f=c.check(),g=c.token();0===g.length&&f&&(g=c.getToken(),d.setDefaultHeaders({access_token:g})),e.authenticate&&!f&&(b.go("login"),a.preventDefault(),window.location.reload())})}]),sugar.factory("SugarFactory",["Restangular",function(a){return{getEntity:function(b){return a.all(b).getList()},createEntity:function(b){return a.all(b)},getCategories:function(){return[{title:"Sunless Spray Tanning",id:"sunless-spray-tanning",description:""},{title:"Bikini",id:"bikini",description:""},{title:"Body",id:"body",description:""},{title:"Face",id:"face",description:"description"},{title:"For the gents",id:"for-the-gents",description:"description"}]},getStorage:function(){var a=localStorage.getItem("sugar");return console.log(a),null==a||"undefined"==typeof a||_.isEmpty(a)||"[object Object]"===a.toString()?{}:JSON.parse(a)},setStorage:function(a){var b=JSON.stringify(a);localStorage.setItem("sugar",b)},emailMessage:function(a){return'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta name="viewport" content="width=device-width"/><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><title>Really Simple HTML Email Template</title><style>*{margin: 0;padding: 0;font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif;font-size: 100%;line-height: 1.6;}img{max-width: 100%;}body{-webkit-font-smoothing: antialiased;-webkit-text-size-adjust: none;width: 100%!important;height: 100%;}a{color: #348eda;}.btn-primary{text-decoration: none;color: #FFF;background-color: #348eda;border: solid #348eda;border-width: 10px 20px;line-height: 2;font-weight: bold;margin-right: 10px;text-align: center;cursor: pointer;display: inline-block;border-radius: 25px;}.btn-secondary{text-decoration: none;color: #FFF;background-color: #aaa;border: solid #aaa;border-width: 10px 20px;line-height: 2;font-weight: bold;margin-right: 10px;text-align: center;cursor: pointer;display: inline-block;border-radius: 25px;}.last{margin-bottom: 0;}.first{margin-top: 0;}.padding{padding: 10px 0;}table.body-wrap{width: 100%;padding: 20px;}table.body-wrap .container{border: 1px solid #f0f0f0;}table.footer-wrap{width: 100%;clear: both!important;}.footer-wrap .container p{font-size: 12px;color: #666;}table.footer-wrap a{color: #999;}h1, h2, h3{font-family: "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;line-height: 1.1;margin-bottom: 15px;color: #000;margin: 10px 0 30px 0;line-height: 1.2;font-weight: 200;}h1{font-size: 36px;}h2{font-size: 28px;}h3{font-size: 22px;}p, ul, ol{margin-bottom: 10px;font-weight: normal;font-size: 14px;}ul li, ol li{margin-left: 5px;list-style-position: inside;}.container{display: block!important;max-width: 600px!important;margin: 0 auto!important;clear: both!important;}.body-wrap .container{padding: 20px;}.content{max-width: 600px;margin: 0 auto;display: block;}.content table{width: 100%;}</style></head><body bgcolor="#f6f6f6"><table class="body-wrap"><tr><td></td><td class="container" bgcolor="#FFFFFF"><div class="content"><table><tr><td><h1>'+a.name+" has sent you a message!</h1><p><strong>Name:</strong> "+a.name+"</p><p><strong>Email Address:</strong> "+a.email+"</p><p><strong>Message:</strong> "+a.message+'</p></td></tr></table></div></td><td></td></tr></table><table class="footer-wrap"><tr><td></td><td class="container"><div class="content"><table><tr><td align="center"><p> This email was sent from your <a href="http://sugarsandiego.com">http://sugarsandiego.com</a> contact form. </p></td></tr></table></div></td><td></td></tr></table></body></html>'},sendEmail:function(b){a.all("email").post(b).then(function(){return console.log("email sent"),!0},function(a){return console.log(a),!1})}}}]),sugar.factory("AuthFactory",["Restangular","SugarFactory",function(a,b){var c=!1,d="";return{login:function(b){var c=this;a.one("auth","login").get(b).then(function(){c.getToken()},function(a){console.log(a)})},getToken:function(){a.one("user","jwt").get().then(function(b){return c=!0,d=b.token,a.setDefaultHeaders({access_token:b.token}),d},function(a){console.log(a)})},logout:function(){a.one("auth","logout").get().then(function(){a.setDefaultHeaders({access_token:null}),c=!1;var d=b.getStorage();d.session.hasAuth=!1,d.session.token=null,b.setStorage(d)},function(a){console.log(a)})},check:function(){if(!c){var a=b.getStorage();_.isEmpty(a.session)||(c=a.session.hasAuth)}return c},token:function(){return d}}}]),sugar.controller("SugarController",["$scope","parallaxHelper","$modal","$http","$rootScope","$state","AuthFactory","SugarFactory",function(a,b,c,d,e,f,g){a.background=b.createAnimator(-.3,150,-150),a.openBooking=function(){var b=c.open({templateUrl:"components/sections/schedulicity.html",resolve:{items:function(){return a.items}}});b.result.then(function(b){a.selected=b},function(){})},e.$on("$stateChangeStart",function(b,c){a.state=c,a.state.nicename=c.name.replace(/-/g," ")}),a.checkAuth=function(){return a.hasAuth=g.check(),a.hasAuth},a.logout=function(){g.logout(),f.go("login")}}]),sugar.controller("SectionsController",["$scope","parallaxHelper","SugarFactory",function(a,b,c){function d(b){a.services={},_.forEach(b,function(b){var c=b.category.toLowerCase().replace(/ /g,"-");(null===a.services[c]||"undefined"==typeof a.services[c])&&(a.services[c]=[]),a.services[c].push(b)}),console.log(a.services)}a.formSubmitted=!1,a.selectedCategory="Bikini",c.getEntity("section").then(function(b){a.sections=[],_.forEach(b.plain(),function(b){"services"!==b.title&&a.sections.push(b)})}),c.getEntity("service").then(function(a){d(a.plain())}),c.getEntity("contact").then(function(b){a.contact=b.plain()[0],console.log(a.contact)}),a.selectCategory=function(b){console.log(b),a.selectedCategory=b[0].category};var e=L.mapbox.map("map","justinwoodcock.il70lk8f",{shareControl:!1});e.touchZoom.disable(),e.scrollWheelZoom.disable(),a.sendEmail=function(){var b=c.emailMessage({name:a.name,email:a.email,message:a.message}),d={name:a.name,email:a.email,message:b};c.sendEmail(d),a.name="",a.email="",a.message="",a.formSubmitted=!0}}]),sugar.controller("AdminImagesController",["$scope","SugarFactory","$filter","$upload",function(a,b,c,d){function e(){b.getEntity("file").then(function(b){a.ImageEntity=b,a.images=b.plain()})}function f(b){if(!b)var b=5e3;setTimeout(function(){a.alert={show:!1},a.$apply()},b)}a.section={},a.edit=!1,a.alert={show:!1},e(),a.onFileSelect=function(b){for(var c=0;c<b.length;c++){var g=b[c];a.upload=d.upload({url:"http://api.sugarsandiego.com/file/upload",data:{files:g}}).progress(function(b){a.uploadProgress=parseInt(100*b.loaded/b.total)}).success(function(b){var c=b.file[0];c.storedAs=c.fd.replace("/var/www/SugarSD/ui/dist/images/",""),a.ImageEntity.post(c).then(function(){e(),a.alert={show:!0,message:c.filename+" has been uploaded.",type:"success"},f()})}).error(function(){console.log("error uploading file.")})}},a.deleteImage=function(b,c){a.ImageEntity[c].remove().then(function(){a.alert={show:!0,message:b.filename+" has been deleted.",type:"success"},f(),e()})},a.getLink=function(a){prompt("The image url is:","/images/"+a.storedAs)}}]),sugar.controller("AdminSectionsController",["$scope","SugarFactory","$filter","ngTableParams","$upload","$http","Restangular",function(a,b){function c(){b.getEntity("section").then(function(b){a.SectionEntity=b,a.sections=b.plain()})}function d(b){if(!b)var b=5e3;setTimeout(function(){a.alert={show:!1},a.$apply()},b)}a.section={},a.data={},a.edit=!1,a.alert={show:!1},c(),b.getEntity("file").then(function(b){a.images=b.plain()}),a.create=function(){a.SectionEntity.post(a.section).then(function(){c(),a.section={},a.showForm=!1,a.editIndex=null,a.alert={show:!0,message:"The section has been successfully created!",type:"success"},d()},function(){a.alert={show:!0,message:"Oops, something went wrong! Please try again.",type:"danger"},d()})},a.update=function(){delete a.section.$$hashKey,a.SectionEntity[a.editIndex].put(a.section).then(function(){a.edit=!1,a.section={},a.showForm=!1,a.alert={show:!0,message:"The section has been successfully updated!",type:"success"},d()},function(){a.alert={show:!0,message:"Oops, something went wrong! Please try again.",type:"danger"},d()})},a.addSection=function(){a.edit=!1,a.showForm=!0,a.section={}},a.editSection=function(b,c){return _.isEmpty(a.section)===!1&&a.section.title===b.title?void a.cancel():(a.edit=!0,a.showForm=!0,a.editIndex=c,void(a.section=b))},a.cancel=function(){a.edit=!1,a.section={},a.editIndex=null,a.showForm=!1},a.delete=function(b,e){a.SectionEntity[e].remove().then(function(){a.alert={show:!0,message:"The "+b.title+" section has been deleted.",type:"success"},d(),c()})}}]),sugar.controller("AdminServicesController",["$scope","SugarFactory","$filter","ngTableParams",function(a,b,c,d){function e(){b.getEntity("service").then(function(b){return a.ServiceEntity=b,a.services=b.plain(),h===!0?(g(),void(h=!1)):void a.tableParams.reload()})}function f(){setTimeout(function(){a.alert={show:!1},a.$apply()},5e3)}function g(){a.tableParams=new d({page:1,count:10},{groupBy:"category",total:a.services.length,getData:function(b,d){var e=d.sorting()?c("orderBy")(a.services,a.tableParams.orderBy()):a.services;b.resolve(e.slice((d.page()-1)*d.count(),d.page()*d.count()))}})}a.service={},a.data={},a.edit=!1,a.showForm=!1,a.alert={show:!1};var h=!0;e(),a.data.categories=b.getCategories(),a.selectCategory=function(b,c){a.service[c]=b,console.log(a)},a.selectItemToEdit=function(b){console.log(b),a.service=b,a.showForm=!0,a.edit=!0},a.editService=function(){console.log(a.service);var b=_.filter(a.ServiceEntity,{id:a.service.id});console.log(b),b[0]=_.merge(b[0],a.service),b[0].put().then(function(){a.showForm=!1,a.edit=!1,a.service={},a.alert={show:!0,message:"The service has been successfully updated!",type:"success"},f(),e()},function(){a.service={},a.alert={show:!0,message:"Oops, something went wrong! Please try again.",type:"danger"},f()})},a.addService=function(){var b=a.service;b.category=a.service.category.title,a.ServiceEntity.post(b).then(function(){a.alert={show:!0,message:"The service has been successfully added!",type:"success"},f(),a.showForm=!1,a.service={},e()},function(b){console.log(b),a.alert={show:!0,message:"Oops, something went wrong! Please try again.",type:"danger"},f()})},a.deleteService=function(b){var c=_.filter(a.ServiceEntity,{id:b.id});c[0].remove().then(function(){a.alert={show:!0,message:"The service has been successfully deleted.",type:"success"},f(),e()},function(b){console.log(b),a.alert={show:!0,message:"Oops, something went wrong! Please try again.",type:"danger"},f()})}}]),sugar.controller("AdminSpecialsController",["$scope","SugarFactory","$filter","ngTableParams",function(a,b,c,d){function e(){b.getEntity("special").then(function(b){return a.SpecialEntity=b,a.specials=b.plain(),h===!0?(g(),void(h=!1)):void a.tableParams.reload()})}function f(){setTimeout(function(){a.alert={show:!1},a.$apply()},5e3)}function g(){a.tableParams=new d({page:1,count:10},{total:a.specials.length,getData:function(b,d){var e=d.sorting()?c("orderBy")(a.services,a.tableParams.orderBy()):a.specials;b.resolve(e.slice((d.page()-1)*d.count(),d.page()*d.count()))}})}a.special={},a.data={},a.edit=!1,a.showForm=!1,a.alert={show:!1};var h=!0;e(),a.selectItemToEdit=function(b){console.log(b),a.service=b,a.showForm=!0,a.edit=!0},a.edit=function(){console.log(a.service);var b=_.filter(a.ServiceEntity,{id:a.service.id});console.log(b),b[0]=_.merge(b[0],a.service),b[0].put().then(function(){a.showForm=!1,a.edit=!1,a.service={},a.alert={show:!0,message:"The service has been successfully updated!",type:"success"},f(),getServiceEntity()},function(){a.service={},a.alert={show:!0,message:"Oops, something went wrong! Please try again.",type:"danger"},f()})},a.create=function(){a.SpecialEntity.post(a.service).then(function(){a.alert={show:!0,message:"The service has been successfully added!",type:"success"},f(),a.showForm=!1,a.service={},getServiceEntity()},function(b){console.log(b),a.alert={show:!0,message:"Oops, something went wrong! Please try again.",type:"danger"},f()})},a.delete=function(b){var c=_.filter(a.SpecialEntity,{id:b.id});c[0].remove().then(function(){a.alert={show:!0,message:"The special has been successfully deleted.",type:"success"},f(),e()},function(b){console.log(b),a.alert={show:!0,message:"Oops, something went wrong! Please try again.",type:"danger"},f()})}}]),sugar.controller("AdminContactController",["$scope","SugarFactory","$filter","ngTableParams","$upload","$http","Restangular",function(a,b){function c(){setTimeout(function(){a.alert={show:!1},a.$apply()},5e3)}a.section={},a.service={},a.data={},a.edit=!1,a.alert={show:!1},b.getEntity("contact").then(function(b){a.ContactEntity=b,a.contact=b.plain()[0]},function(a){console.log(a)}),a.updateContact=function(){a.ContactEntity[0].put(a.contact).then(function(){a.alert={show:!0,message:"Your contact information has been successfully updated!",type:"success"},c()},function(){a.alert={show:!0,message:"Oops, something went wrong! Please try again.",type:"danger"},c()})}}]),sugar.controller("LoginController",["$scope","AuthFactory","$state","SugarFactory",function(a,b,c,d){a.show="login",a.login=function(){var e={email:a.email,password:a.password};b.login(e),setTimeout(function(){var a=b.check();if(a){var e=d.getStorage();e.session={hasAuth:!0,token:b.token()},d.setStorage(e),c.go("admin-specials")}},750)},a.register=function(){var c={username:a.username,email:a.email,password:a.password};b.login(c)}}]);